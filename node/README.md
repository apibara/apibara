# Apibara Node

A node combines and transforms multiple input streams into a new output stream.

## Stream Protocol

All messages in the Apibara stream protocol are identified by a sequence number.
Clients must check that the messages they receive have increasing sequence
numbers without gaps (except in the case of message invalidation).

The following messages are part of the protocol:

- `Data(sequence, data)`: contains the message data together with its sequence
  number.
- `Invalidate(sequence)`: informs the client that all messages with sequence
  number greater than or equal to the specified `sequence` are now invalid. The
  stream will resume by sending the new messages from the specified `sequence`
  number.

Invalidation is needed because web3 data is not finalized immediately. Chain
reorganizations cause blocks that were previously considered canonical to be
removed from the canonical chain. By making data invalidation a core part of the
protocol, nodes can push information about chain reorganizations downstream.

## Node Implementation

A node is responsible for tracking the state of each input stream across
restarts. It also manages the sequence number generator so that output messages
are correctly sequenced. Finally, the node stores the messages generated by the
stream to persistent storage so that they can be replied to clients that connect
at a later point in time.

The data transformation and aggregation is performed by applications.
Applications communicate with the node through gRPC and must be started
separately.

## Source Nodes

Nodes that ingest data from an outside source and into Apibara are called
_source nodes_. Source nodes can, for example, ingest data from a blockchain
node and generate a stream of Apibara messages. Blockchain nodes can implement
the Apibara stream protocol directly for lower latency.

Source nodes are not limited to blockchain nodes: an HTTP server can generate a
stream of user actions (e.g. `CommentPosted`, `PostLiked`, `FriendRequestSent`,
etc.) to create applications that mix off-chain and on-chain data.
